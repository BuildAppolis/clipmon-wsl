#!/bin/bash

# Clipboard Monitor - Background Mode
# Runs silently and saves a PID file for easy stopping

PROJECT_DIR="${1:-$(pwd)}"
CAPTURES_DIR="$PROJECT_DIR/.claude/captures"
PID_FILE="$HOME/.claude/clipmon.pid"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# Function to start monitor
start_monitor() {
    # Check if already running
    if [ -f "$PID_FILE" ]; then
        OLD_PID=$(cat "$PID_FILE")
        if ps -p "$OLD_PID" > /dev/null 2>&1; then
            echo -e "${YELLOW}Monitor already running (PID: $OLD_PID)${NC}"
            echo -e "Use 'clipmon-bg stop' to stop it"
            exit 1
        fi
    fi
    
    echo -e "${CYAN}Starting Clipboard Monitor in background...${NC}"
    echo -e "Project: ${YELLOW}$PROJECT_DIR${NC}"
    
    # Create captures directory
    mkdir -p "$CAPTURES_DIR"
    
    # Start monitor in background
    nohup powershell.exe -ExecutionPolicy Bypass -File "$(wslpath -w /home/cory-ubuntu/.claude/tools/clipboard-monitor-enhanced.ps1)" \
        -ProjectPath "$(wslpath -w "$PROJECT_DIR")" > /dev/null 2>&1 &
    
    PID=$!
    echo $PID > "$PID_FILE"
    
    echo -e "${GREEN}âœ“ Monitor started (PID: $PID)${NC}"
    echo -e "${GREEN}âœ“ Saving to: $CAPTURES_DIR${NC}"
    echo ""
    echo -e "Commands:"
    echo -e "  ${CYAN}clipmon-bg stop${NC}  - Stop monitoring"
    echo -e "  ${CYAN}clipmon-bg status${NC} - Check status"
    echo -e "  ${CYAN}clipmon refs${NC}      - View captures"
}

# Function to stop monitor
stop_monitor() {
    if [ ! -f "$PID_FILE" ]; then
        echo -e "${YELLOW}No monitor running${NC}"
        exit 0
    fi
    
    PID=$(cat "$PID_FILE")
    
    if ps -p "$PID" > /dev/null 2>&1; then
        kill "$PID" 2>/dev/null
        echo -e "${GREEN}âœ“ Monitor stopped (PID: $PID)${NC}"
    else
        echo -e "${YELLOW}Monitor not running (stale PID file)${NC}"
    fi
    
    rm -f "$PID_FILE"
}

# Function to check status
check_status() {
    if [ ! -f "$PID_FILE" ]; then
        echo -e "${RED}âš« Monitor not running${NC}"
        exit 1
    fi
    
    PID=$(cat "$PID_FILE")
    
    if ps -p "$PID" > /dev/null 2>&1; then
        echo -e "${GREEN}ðŸŸ¢ Monitor running (PID: $PID)${NC}"
        
        # Check captures
        if [ -d "$CAPTURES_DIR" ]; then
            COUNT=$(ls -1 "$CAPTURES_DIR"/img_* 2>/dev/null | wc -l)
            echo -e "   Captures: ${CYAN}$COUNT files${NC}"
            echo -e "   Location: ${CYAN}$CAPTURES_DIR${NC}"
        fi
    else
        echo -e "${RED}âš« Monitor not running (stale PID)${NC}"
        rm -f "$PID_FILE"
        exit 1
    fi
}

# Main command
COMMAND="${1:-start}"
if [[ "$COMMAND" == /* ]] || [[ "$COMMAND" == ./* ]]; then
    # First arg is a directory path
    PROJECT_DIR="$1"
    COMMAND="${2:-start}"
fi

case "$COMMAND" in
    start)
        start_monitor
        ;;
    stop)
        stop_monitor
        ;;
    status)
        check_status
        ;;
    restart)
        stop_monitor
        sleep 1
        start_monitor
        ;;
    *)
        echo -e "${CYAN}Clipboard Monitor - Background Mode${NC}"
        echo ""
        echo "Usage:"
        echo "  clipmon-bg [dir] start   - Start monitoring"
        echo "  clipmon-bg stop          - Stop monitoring"
        echo "  clipmon-bg status        - Check status"
        echo "  clipmon-bg restart       - Restart monitor"
        ;;
esac